---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netdata
  namespace: netdata
spec:
  interval: 30m
  timeout: 15m0s
  chart:
    spec:
      chart: netdata
      version: "3.x"
      sourceRef:
        kind: HelmRepository
        name: netdata
        namespace: netdata
      interval: 12h
  
  install:
    timeout: 15m0s
    remediation:
      retries: 3
  upgrade:
    timeout: 15m0s
    remediation:
      retries: 3
  
  # ULTRA-MINIMAL configuration for 2GB nodes
  values:
    # Parent Configuration - Absolute minimum resources
    parent:
      # Minimal resource limits
      resources:
        limits:
          cpu: 300m
          memory: 256Mi    # Reduced from 384Mi
        requests:
          cpu: 50m         # Reduced from 100m
          memory: 96Mi     # Reduced from 128Mi - absolute minimum
      
      # Minimal database
      database:
        persistence: true
        volumesize: 500Mi  # Reduced from 1Gi - 1-2 days retention
        storageclass: "local-path"
      
      service:
        type: LoadBalancer
        annotations:
          metallb.universe.tf/loadBalancerIPs: "192.168.99.122"
        port: 19999
      
      # Ultra-minimal parent configuration
      configs:
        netdata:
          enabled: true
          path: /etc/netdata/netdata.conf
          data: |
            [global]
              hostname = netdata-parent
              memory mode = dbengine
              page cache size = 16            # Minimal cache
              dbengine multihost disk space = 512
              update every = 2                # Collect every 2 seconds instead of 1
            
            [db]
              mode = dbengine
              storage tiers = 1               # Only 1 tier instead of 2
              
            [health]
              enabled = yes
            
            [ml]
              enabled = no
            
            [web]
              mode = multi-threaded
              web files owner = root
              web files group = root
              bind to = *
            
            [plugins]
              # Disable resource-intensive plugins
              apps = no                       # Disable per-app monitoring
              cgroups = no                    # Disable cgroup monitoring on parent
              diskspace = no                  # Disable diskspace plugin
              tc = no
              idlejitter = no
        
        stream:
          enabled: true
          path: /etc/netdata/stream.conf
          data: |
            [a6ac2c88-463b-4b64-81e2-9a79d6110781]
              enabled = yes
              default memory mode = dbengine
              allow from = *
      
      claiming:
        enabled: false
      
      # Schedule parent on worker node if possible (it has most free memory)
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/worker
                    operator: Exists

    # Child Configuration - Ultra-minimal
    child:
      enabled: true
      
      # Absolute minimum resources
      resources:
        limits:
          cpu: 100m        # Reduced from 150m
          memory: 80Mi     # Reduced from 100Mi
        requests:
          cpu: 30m         # Reduced from 50m
          memory: 48Mi     # Reduced from 64Mi - absolute minimum
      
      configs:
        netdata:
          enabled: true
          path: /etc/netdata/netdata.conf
          data: |
            [global]
              memory mode = ram
              page cache size = 2             # Minimal cache
              hostname = $HOSTNAME
              update every = 2                # Collect every 2 seconds instead of 1
            
            [db]
              mode = ram
              retention = 1800                # 30 minutes instead of 1 hour
              storage tiers = 1
            
            [health]
              enabled = no
            
            [ml]
              enabled = no
            
            [plugins]
              # Disable heavy plugins on children
              apps = no                       # Big memory saver
              cgroups = yes                   # Keep this for container monitoring
              diskspace = no
              tc = no
              idlejitter = no
              netdata monitoring = no
            
            [web]
              mode = none
        
        stream:
          enabled: true
          path: /etc/netdata/stream.conf
          data: |
            [stream]
              enabled = yes
              destination = netdata-parent:19999
              api key = a6ac2c88-463b-4b64-81e2-9a79d6110781
              timeout seconds = 60
              default port = 19999
              send charts matching = *
              buffer size bytes = 524288      # Reduced buffer
              reconnect delay seconds = 5
              initial clock resync iterations = 60
      
      claiming:
        enabled: false
      
      hostNetwork: false
      
      persistence:
        enabled: true
        hostPath: /var/lib/netdata-k8s-child
      
      updateStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 1

    # Disable K8s State monitoring to save resources
    k8sState:
      enabled: false  # DISABLED - saves ~100MB

    # Service Discovery - minimal
    sd:
      child:
        enabled: true
        configmap:
          name: netdata-child-sd-config
          from:
            value: |
              name: kubernetes
              tags: k8s

    rbac:
      create: true
      psp: false

    serviceAccount:
      create: true
      name: netdata

    notifications:
      slack:
        webhook_url: ""
        recipient: ""

    ingress:
      enabled: false
